name: ðŸ—ï¸ IaC Management | Stop/Start Resources

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Infrastructure Action'
        required: true
        type: choice
        options:
          - stop-all
          - start-all
          - stop-database
          - start-database
          - stop-container-app
          - start-container-app
          - destroy-redis
          - recreate-redis
          - destroy-acr
          - recreate-acr
          - destroy-storage-resources
          - recreate-storage-resources
        default: 'stop-all'
      confirm_destructive:
        description: 'Confirm destructive actions (destroy-redis, recreate-redis, destroy-acr, recreate-acr, destroy-storage-resources, recreate-storage-resources)'
        required: false
        type: boolean
        default: false

env:
  # Infrastructure configuration
  RESOURCE_GROUP: 'tc-cloudgames-dev-rg'
  CONTAINER_APP_NAME: 'tc-cloudgames-dev-api-app'
  POSTGRES_SERVER_NAME: 'tc-cloudgames-dev-db'
  REDIS_CACHE_NAME: 'tc-cloudgames-dev-redis'
  ACR_NAME: 'tc-cloudgames-dev-acr'
  
  # Terraform Cloud configuration
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
  TF_CLOUD_ORGANIZATION: ${{ secrets.TF_CLOUD_ORGANIZATION }}
  TF_WORKSPACE: ${{ secrets.TF_WORKSPACE }}
  
  # Azure credentials
  CREDENTIALS: ${{ secrets.MAIN_AZURE_CREDENTIALS }}

jobs:
  # Job 1: Stop/Start Azure Resources via CLI
  manage-azure-resources:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      contains(fromJSON('["stop-all", "start-all", "stop-database", "start-database", "stop-container-app", "start-container-app"]'), github.event.inputs.action)
    steps:
      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ env.CREDENTIALS }}

      - name: ðŸ›‘ Stop Database Server
        if: contains(fromJSON('["stop-all", "stop-database"]'), github.event.inputs.action)
        run: |
          echo "ðŸ›‘ Stopping PostgreSQL Flexible Server..."
          
          # First check if any PostgreSQL servers exist in the resource group
          SERVER_COUNT=$(az postgres flexible-server list \
            --resource-group "$RESOURCE_GROUP" \
            --query "length(@)" \
            --output tsv 2>/dev/null || echo "0")
          
          if [ "$SERVER_COUNT" == "0" ]; then
            echo "â„¹ï¸ No PostgreSQL servers found in resource group '$RESOURCE_GROUP'"
            echo "âœ… Database stop operation completed (nothing to stop)"
            exit 0
          fi
          
          # Get the actual server name (it includes a random suffix)
          SERVER_NAME=$(az postgres flexible-server list \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?contains(name, 'tc-cloudgames-dev-db')].name" \
            --output tsv 2>/dev/null)
          
          if [ -z "$SERVER_NAME" ]; then
            echo "â„¹ï¸ PostgreSQL server with pattern 'tc-cloudgames-dev-db' not found"
            echo "ðŸ“‹ Available PostgreSQL servers in resource group:"
            az postgres flexible-server list \
              --resource-group "$RESOURCE_GROUP" \
              --query "[].{Name:name, State:state}" \
              --output table 2>/dev/null || echo "  None found or error querying"
            echo "âœ… Database stop operation completed (target server not found)"
            exit 0
          fi
          
          echo "Found server: $SERVER_NAME"
          
          # Check current status
          CURRENT_STATUS=$(az postgres flexible-server show \
            --name "$SERVER_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "state" \
            --output tsv 2>/dev/null)
          
          echo "Current status: $CURRENT_STATUS"
          
          if [ "$CURRENT_STATUS" == "Ready" ]; then
            echo "ðŸ”„ Stopping database server..."
            az postgres flexible-server stop \
              --name "$SERVER_NAME" \
              --resource-group "$RESOURCE_GROUP" 2>/dev/null
            
            if [ $? -eq 0 ]; then
              echo "âœ… Database server stopped successfully"
            else
              echo "âš ï¸ Failed to stop database server - it may be in transition state"
            fi
          elif [ "$CURRENT_STATUS" == "Stopped" ]; then
            echo "â„¹ï¸ Database server is already stopped"
          else
            echo "âš ï¸ Database server is in state: $CURRENT_STATUS - cannot stop"
          fi

      - name: ðŸš€ Start Database Server
        if: contains(fromJSON('["start-all", "start-database"]'), github.event.inputs.action)
        run: |
          echo "ðŸš€ Starting PostgreSQL Flexible Server..."
          
          # First check if any PostgreSQL servers exist in the resource group
          SERVER_COUNT=$(az postgres flexible-server list \
            --resource-group "$RESOURCE_GROUP" \
            --query "length(@)" \
            --output tsv 2>/dev/null || echo "0")
          
          if [ "$SERVER_COUNT" == "0" ]; then
            echo "â„¹ï¸ No PostgreSQL servers found in resource group '$RESOURCE_GROUP'"
            echo "âš ï¸ Database needs to be deployed first before it can be started"
            exit 0
          fi
          
          # Get the actual server name (it includes a random suffix)
          SERVER_NAME=$(az postgres flexible-server list \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?contains(name, 'tc-cloudgames-dev-db')].name" \
            --output tsv 2>/dev/null)
          
          if [ -z "$SERVER_NAME" ]; then
            echo "â„¹ï¸ PostgreSQL server with pattern 'tc-cloudgames-dev-db' not found"
            echo "ðŸ“‹ Available PostgreSQL servers in resource group:"
            az postgres flexible-server list \
              --resource-group "$RESOURCE_GROUP" \
              --query "[].{Name:name, State:state}" \
              --output table 2>/dev/null || echo "  None found or error querying"
            echo "âš ï¸ Database needs to be deployed first before it can be started"
            exit 0
          fi
          
          echo "Found server: $SERVER_NAME"
          
          # Check current status
          CURRENT_STATUS=$(az postgres flexible-server show \
            --name "$SERVER_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "state" \
            --output tsv 2>/dev/null)
          
          echo "Current status: $CURRENT_STATUS"
          
          if [ "$CURRENT_STATUS" == "Stopped" ]; then
            echo "ðŸ”„ Starting database server..."
            az postgres flexible-server start \
              --name "$SERVER_NAME" \
              --resource-group "$RESOURCE_GROUP" 2>/dev/null
            
            if [ $? -eq 0 ]; then
              echo "âœ… Database server started successfully"
            else
              echo "âš ï¸ Failed to start database server - it may be in transition state"
            fi
          elif [ "$CURRENT_STATUS" == "Ready" ]; then
            echo "â„¹ï¸ Database server is already running"
          else
            echo "âš ï¸ Database server is in state: $CURRENT_STATUS - cannot start"
          fi

      - name: ðŸ›‘ Stop Container App
        if: contains(fromJSON('["stop-all", "stop-container-app"]'), github.event.inputs.action)
        run: |
          echo "ðŸ›‘ Stopping Container App by setting min replicas to 0..."
          
          # First check if any container apps exist in the resource group
          APP_COUNT=$(az containerapp list \
            --resource-group "$RESOURCE_GROUP" \
            --query "length(@)" \
            --output tsv 2>/dev/null || echo "0")
          
          if [ "$APP_COUNT" == "0" ]; then
            echo "â„¹ï¸ No container apps found in resource group '$RESOURCE_GROUP'"
            echo "âœ… Container app stop operation completed (nothing to stop)"
            exit 0
          fi
          
          # Get the actual container app name (it includes a random suffix if any)
          APP_NAME=$(az containerapp list \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?contains(name, 'tc-cloudgames-dev-api-app')].name" \
            --output tsv 2>/dev/null)
          
          if [ -z "$APP_NAME" ]; then
            echo "â„¹ï¸ Container app with pattern 'tc-cloudgames-dev-api-app' not found"
            echo "ðŸ“‹ Available container apps in resource group:"
            az containerapp list \
              --resource-group "$RESOURCE_GROUP" \
              --query "[].{Name:name, Status:properties.provisioningState}" \
              --output table 2>/dev/null || echo "  None found or error querying"
            echo "âœ… Container app stop operation completed (target app not found)"
            exit 0
          fi
          
          echo "Found container app: $APP_NAME"
          
          # Check if the app is in a valid state for modification
          PROVISIONING_STATE=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.provisioningState" \
            --output tsv 2>/dev/null)
          
          echo "Provisioning state: $PROVISIONING_STATE"
          
          if [ "$PROVISIONING_STATE" != "Succeeded" ]; then
            echo "âš ï¸ Container app is in state '$PROVISIONING_STATE' - cannot modify"
            echo "Please wait for the app to reach 'Succeeded' state before stopping"
            exit 0
          fi
          
          # Get current replica configuration
          CURRENT_MIN=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.template.scale.minReplicas" \
            --output tsv 2>/dev/null)
          
          CURRENT_MAX=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.template.scale.maxReplicas" \
            --output tsv 2>/dev/null)
          
          echo "Current configuration: min=$CURRENT_MIN, max=$CURRENT_MAX"
          
          if [ "$CURRENT_MIN" != "0" ]; then
            echo "ðŸ”„ Updating container app to stop..."
            # Only update min replicas to 0, keep max at 10 for quick restart
            az containerapp update \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --min-replicas 0 \
              --max-replicas 10 2>/dev/null
            
            if [ $? -eq 0 ]; then
              echo "âœ… Container app stopped (min replicas set to 0, max remains 10)"
            else
              echo "âš ï¸ Failed to update container app - it may be in transition state"
            fi
          else
            echo "â„¹ï¸ Container app is already stopped (min replicas = 0)"
          fi

      - name: ðŸš€ Start Container App
        if: contains(fromJSON('["start-all", "start-container-app"]'), github.event.inputs.action)
        run: |
          echo "ðŸš€ Starting Container App by setting min replicas to 1..."
          
          # First check if any container apps exist in the resource group
          APP_COUNT=$(az containerapp list \
            --resource-group "$RESOURCE_GROUP" \
            --query "length(@)" \
            --output tsv 2>/dev/null || echo "0")
          
          if [ "$APP_COUNT" == "0" ]; then
            echo "â„¹ï¸ No container apps found in resource group '$RESOURCE_GROUP'"
            echo "âš ï¸ Container app needs to be deployed first before it can be started"
            exit 0
          fi
          
          # Get the actual container app name
          APP_NAME=$(az containerapp list \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?contains(name, 'tc-cloudgames-dev-api-app')].name" \
            --output tsv 2>/dev/null)
          
          if [ -z "$APP_NAME" ]; then
            echo "â„¹ï¸ Container app with pattern 'tc-cloudgames-dev-api-app' not found"
            echo "ðŸ“‹ Available container apps in resource group:"
            az containerapp list \
              --resource-group "$RESOURCE_GROUP" \
              --query "[].{Name:name, Status:properties.provisioningState}" \
              --output table 2>/dev/null || echo "  None found or error querying"
            echo "âš ï¸ Container app needs to be deployed first before it can be started"
            exit 0
          fi
          
          echo "Found container app: $APP_NAME"
          
          # Check if the app is in a valid state for modification
          PROVISIONING_STATE=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.provisioningState" \
            --output tsv 2>/dev/null)
          
          echo "Provisioning state: $PROVISIONING_STATE"
          
          if [ "$PROVISIONING_STATE" != "Succeeded" ]; then
            echo "âš ï¸ Container app is in state '$PROVISIONING_STATE' - cannot modify"
            echo "Please wait for the app to reach 'Succeeded' state before starting"
            exit 0
          fi
          
          # Get current replica configuration
          CURRENT_MIN=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.template.scale.minReplicas" \
            --output tsv 2>/dev/null)
          
          CURRENT_MAX=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.template.scale.maxReplicas" \
            --output tsv 2>/dev/null)
          
          echo "Current configuration: min=$CURRENT_MIN, max=$CURRENT_MAX"
          
          if [ "$CURRENT_MIN" == "0" ] || [ "$CURRENT_MIN" == "null" ]; then
            echo "ðŸ”„ Updating container app to start..."
            # Set min replicas to 1 to ensure the app starts, keep max at 10 for scaling
            az containerapp update \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --min-replicas 1 \
              --max-replicas 10 2>/dev/null
            
            if [ $? -eq 0 ]; then
              echo "âœ… Container app started (min replicas set to 1, max remains 10)"
            else
              echo "âš ï¸ Failed to update container app - it may be in transition state"
            fi
          else
            echo "â„¹ï¸ Container app is already running (min replicas: $CURRENT_MIN)"
          fi

      - name: ðŸ“Š Resource Status Summary
        if: always()
        run: |
          echo "ðŸ“Š Current Resource Status:"
          echo "========================="
          
          # Database status
          echo "ðŸ—„ï¸ Database Status:"
          SERVER_NAME=$(az postgres flexible-server list \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?contains(name, 'tc-cloudgames-dev-db')].name" \
            --output tsv)
          
          if [ -n "$SERVER_NAME" ]; then
            DB_STATUS=$(az postgres flexible-server show \
              --name "$SERVER_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --query "state" \
              --output tsv)
            echo "  Server: $SERVER_NAME"
            echo "  Status: $DB_STATUS"
          fi
          
          # Container app status
          echo ""
          echo "ðŸ“¦ Container App Status:"
          APP_NAME=$(az containerapp list \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?contains(name, 'tc-cloudgames-dev-api-app')].name" \
            --output tsv)
          
          if [ -n "$APP_NAME" ]; then
            MIN_REPLICAS=$(az containerapp show \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --query "properties.template.scale.minReplicas" \
              --output tsv)
            
            MAX_REPLICAS=$(az containerapp show \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --query "properties.template.scale.maxReplicas" \
              --output tsv)
            
            echo "  App: $APP_NAME"
            echo "  Scale Configuration: min=$MIN_REPLICAS, max=$MAX_REPLICAS"
            
            if [ "$MIN_REPLICAS" == "0" ]; then
              echo "  Status: ðŸ›‘ Stopped (min replicas = 0)"
            else
              echo "  Status: ðŸš€ Active (min replicas = $MIN_REPLICAS)"
            fi
          fi

  # Job 2: Manage Storage Resources (Redis + ACR) via Terraform Cloud
  manage-storage-terraform:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      contains(fromJSON('["destroy-redis", "recreate-redis", "destroy-acr", "recreate-acr", "destroy-storage-resources", "recreate-storage-resources"]'), github.event.inputs.action)
    steps:
      - name: ðŸ” Azure Login (for Container App secrets update)
        if: github.event.inputs.action == 'recreate-redis'
        uses: azure/login@v2
        with:
          creds: ${{ env.CREDENTIALS }}

      - name: âš ï¸ Validate Destructive Action Confirmation
        if: github.event.inputs.confirm_destructive != 'true'
        run: |
          echo "âŒ Destructive action requires confirmation!"
          echo "Please check 'Confirm destructive actions' checkbox to proceed."
          echo ""
          echo "âš ï¸  WARNING: This action will:"
          ACTION="${{ github.event.inputs.action }}"
          
          case "$ACTION" in
            "destroy-redis")
              echo "  â€¢ Permanently destroy the Redis cache"
              echo "  â€¢ All cached data will be lost"
              echo "  â€¢ Applications will lose cache functionality"
              ;;
            "recreate-redis")
              echo "  â€¢ Destroy and recreate the Redis cache"
              echo "  â€¢ All cached data will be lost"
              echo "  â€¢ Cache will be empty after recreation"
              ;;
            "destroy-acr")
              echo "  â€¢ Permanently destroy the Container Registry"
              echo "  â€¢ All container images will be lost"
              echo "  â€¢ Container apps will need image rebuilds"
              ;;
            "recreate-acr")
              echo "  â€¢ Destroy and recreate the Container Registry"
              echo "  â€¢ All container images will be lost"
              echo "  â€¢ Images will need to be rebuilt and pushed"
              ;;
            "destroy-storage-resources")
              echo "  â€¢ Permanently destroy BOTH Redis cache AND Container Registry"
              echo "  â€¢ All cached data AND container images will be lost"
              echo "  â€¢ Applications will lose cache functionality"
              echo "  â€¢ Container apps will need complete rebuild"
              ;;
            "recreate-storage-resources")
              echo "  â€¢ Destroy and recreate BOTH Redis cache AND Container Registry"
              echo "  â€¢ All cached data AND container images will be lost"
              echo "  â€¢ Cache will be empty and images need rebuild"
              ;;
          esac
          exit 1

      - name: ðŸ—‘ï¸ Destroy Redis Cache via Terraform Cloud
        if: contains(fromJSON('["destroy-redis", "destroy-storage-resources"]'), github.event.inputs.action)
        run: |
          echo "ðŸ—‘ï¸ Destroying Redis cache via Terraform Cloud..."
          
          # Get workspace ID
          echo "ðŸ“‹ Getting workspace information..."
          WORKSPACE_ID=$(curl -s \
            -H "Authorization: Bearer $TF_API_TOKEN" \
            -H "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/organizations/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE" \
            | jq -r '.data.id')
          
          if [ "$WORKSPACE_ID" == "null" ] || [ -z "$WORKSPACE_ID" ]; then
            echo "âŒ Failed to get workspace ID"
            echo "Please verify TF_CLOUD_ORGANIZATION and TF_WORKSPACE secrets"
            exit 1
          fi
          
          echo "âœ… Workspace ID: $WORKSPACE_ID"
          
          # Check if Redis resource exists in Terraform state before attempting destroy
          echo "ðŸ” Checking if Redis cache exists in Terraform state..."
          STATE_VERSION_ID=$(curl -s \
            -H "Authorization: Bearer $TF_API_TOKEN" \
            "https://app.terraform.io/api/v2/workspaces/$WORKSPACE_ID/current-state-version" \
            | jq -r '.data.id // "none"')
          
          if [ "$STATE_VERSION_ID" == "none" ] || [ -z "$STATE_VERSION_ID" ]; then
            echo "â„¹ï¸ No Terraform state found - Redis cache likely doesn't exist"
            echo "âœ… Redis destroy operation completed (target resource not found)"
            exit 0
          fi
          
          # Get the state file to check for Redis resource
          REDIS_EXISTS=$(curl -s \
            -H "Authorization: Bearer $TF_API_TOKEN" \
            "https://app.terraform.io/api/v2/state-versions/$STATE_VERSION_ID/download" \
            | jq -r '.resources[] | select(.type == "azurerm_redis_cache") | .type' 2>/dev/null || echo "")
          
          if [ -z "$REDIS_EXISTS" ]; then
            echo "â„¹ï¸ Redis cache not found in Terraform state - may have been destroyed already"
            echo "âœ… Redis destroy operation completed (target resource not in state)"
            exit 0
          fi
          
          echo "âœ… Redis cache found in state - proceeding with destroy"
          
          # Create a targeted destroy plan for Redis only
          echo "ðŸ“‹ Creating targeted destroy run for Redis cache..."
          DESTROY_RUN_ID=$(curl -s \
            -X POST \
            -H "Authorization: Bearer $TF_API_TOKEN" \
            -H "Content-Type: application/vnd.api+json" \
            -d "{
              \"data\": {
                \"type\": \"runs\",
                \"attributes\": {
                  \"message\": \"Destroy Redis cache only - triggered by ${{ github.actor }}\",
                  \"is-destroy\": true,
                  \"target-addrs\": [\"azurerm_redis_cache.redis_cache\"]
                },
                \"relationships\": {
                  \"workspace\": {
                    \"data\": {
                      \"type\": \"workspaces\",
                      \"id\": \"$WORKSPACE_ID\"
                    }
                  }
                }
              }
            }" \
            "https://app.terraform.io/api/v2/runs" \
            | jq -r '.data.id')
          
          if [ "$DESTROY_RUN_ID" == "null" ] || [ -z "$DESTROY_RUN_ID" ]; then
            echo "âŒ Failed to create destroy run"
            exit 1
          fi
          
          echo "âœ… Redis destroy run created: $DESTROY_RUN_ID"
          echo "ðŸ”— Monitor: https://app.terraform.io/app/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE/runs/$DESTROY_RUN_ID"
          
          # Wait for destroy to complete
          echo "â³ Waiting for Redis destroy to complete..."
          for i in {1..30}; do
            RUN_STATUS=$(curl -s \
              -H "Authorization: Bearer $TF_API_TOKEN" \
              "https://app.terraform.io/api/v2/runs/$DESTROY_RUN_ID" \
              | jq -r '.data.attributes.status')
            
            echo "Status ($i/30): $RUN_STATUS"
            
            if [ "$RUN_STATUS" == "applied" ] || [ "$RUN_STATUS" == "planned_and_finished" ]; then
              echo "âœ… Redis destroy completed"
              break
            elif [ "$RUN_STATUS" == "planned" ]; then
              echo "âš ï¸  Manual approval may be required in Terraform Cloud"
              break
            elif [ "$RUN_STATUS" == "errored" ] || [ "$RUN_STATUS" == "canceled" ]; then
              echo "âŒ Redis destroy failed: $RUN_STATUS"
              exit 1
            fi
            
            sleep 10
          done
          
          echo "ðŸ’° Redis Cost Savings: ~$15-25/month"

      - name: ðŸ—‘ï¸ Destroy Container Registry via Terraform Cloud
        if: contains(fromJSON('["destroy-acr", "destroy-storage-resources"]'), github.event.inputs.action)
        run: |
          echo "ðŸ—‘ï¸ Destroying Container Registry via Terraform Cloud..."
          
          # Get workspace ID (reuse from previous step if available)
          if [ -z "$WORKSPACE_ID" ]; then
            echo "ðŸ“‹ Getting workspace information..."
            WORKSPACE_ID=$(curl -s \
              -H "Authorization: Bearer $TF_API_TOKEN" \
              -H "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/organizations/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE" \
              | jq -r '.data.id')
            
            if [ "$WORKSPACE_ID" == "null" ] || [ -z "$WORKSPACE_ID" ]; then
              echo "âŒ Failed to get workspace ID"
              exit 1
            fi
            echo "âœ… Workspace ID: $WORKSPACE_ID"
          fi
          
          # Check if ACR resource exists in Terraform state before attempting destroy
          echo "ðŸ” Checking if Container Registry exists in Terraform state..."
          STATE_VERSION_ID=$(curl -s \
            -H "Authorization: Bearer $TF_API_TOKEN" \
            "https://app.terraform.io/api/v2/workspaces/$WORKSPACE_ID/current-state-version" \
            | jq -r '.data.id // "none"')
          
          if [ "$STATE_VERSION_ID" == "none" ] || [ -z "$STATE_VERSION_ID" ]; then
            echo "â„¹ï¸ No Terraform state found - Container Registry likely doesn't exist"
            echo "âœ… ACR destroy operation completed (target resource not found)"
            exit 0
          fi
          
          # Get the state file to check for ACR resource
          ACR_EXISTS=$(curl -s \
            -H "Authorization: Bearer $TF_API_TOKEN" \
            "https://app.terraform.io/api/v2/state-versions/$STATE_VERSION_ID/download" \
            | jq -r '.resources[] | select(.type == "azurerm_container_registry") | .type' 2>/dev/null || echo "")
          
          if [ -z "$ACR_EXISTS" ]; then
            echo "â„¹ï¸ Container Registry not found in Terraform state - may have been destroyed already"
            echo "âœ… ACR destroy operation completed (target resource not in state)"
            exit 0
          fi
          
          echo "âœ… Container Registry found in state - proceeding with destroy" \
              -H "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/organizations/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE" \
              | jq -r '.data.id')
            
            if [ "$WORKSPACE_ID" == "null" ] || [ -z "$WORKSPACE_ID" ]; then
              echo "âŒ Failed to get workspace ID"
              exit 1
            fi
            echo "âœ… Workspace ID: $WORKSPACE_ID"
          fi
          
          # Create a targeted destroy plan for ACR only
          echo "ðŸ“‹ Creating targeted destroy run for Container Registry..."
          ACR_DESTROY_RUN_ID=$(curl -s \
            -X POST \
            -H "Authorization: Bearer $TF_API_TOKEN" \
            -H "Content-Type: application/vnd.api+json" \
            -d "{
              \"data\": {
                \"type\": \"runs\",
                \"attributes\": {
                  \"message\": \"Destroy Container Registry only - triggered by ${{ github.actor }}\",
                  \"is-destroy\": true,
                  \"target-addrs\": [\"azurerm_container_registry.acr\"]
                },
                \"relationships\": {
                  \"workspace\": {
                    \"data\": {
                      \"type\": \"workspaces\",
                      \"id\": \"$WORKSPACE_ID\"
                    }
                  }
                }
              }
            }" \
            "https://app.terraform.io/api/v2/runs" \
            | jq -r '.data.id')
          
          if [ "$ACR_DESTROY_RUN_ID" == "null" ] || [ -z "$ACR_DESTROY_RUN_ID" ]; then
            echo "âŒ Failed to create ACR destroy run"
            exit 1
          fi
          
          echo "âœ… ACR destroy run created: $ACR_DESTROY_RUN_ID"
          echo "ðŸ”— Monitor: https://app.terraform.io/app/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE/runs/$ACR_DESTROY_RUN_ID"
          
          # Wait for ACR destroy to complete
          echo "â³ Waiting for ACR destroy to complete..."
          for i in {1..30}; do
            RUN_STATUS=$(curl -s \
              -H "Authorization: Bearer $TF_API_TOKEN" \
              "https://app.terraform.io/api/v2/runs/$ACR_DESTROY_RUN_ID" \
              | jq -r '.data.attributes.status')
            
            echo "Status ($i/30): $RUN_STATUS"
            
            if [ "$RUN_STATUS" == "applied" ] || [ "$RUN_STATUS" == "planned_and_finished" ]; then
              echo "âœ… ACR destroy completed"
              break
            elif [ "$RUN_STATUS" == "planned" ]; then
              echo "âš ï¸  Manual approval may be required in Terraform Cloud"
              break
            elif [ "$RUN_STATUS" == "errored" ] || [ "$RUN_STATUS" == "canceled" ]; then
              echo "âŒ ACR destroy failed: $RUN_STATUS"
              exit 1
            fi
            
            sleep 10
          done
          
          echo "ðŸ’° ACR Cost Savings: ~$5-50/month (depending on SKU)"

      - name: ðŸ”„ Recreate Storage Resources via Terraform Cloud
        if: contains(fromJSON('["recreate-redis", "recreate-acr", "recreate-storage-resources"]'), github.event.inputs.action)
        run: |
          ACTION="${{ github.event.inputs.action }}"
          echo "ðŸ”„ Recreating storage resources via Terraform Cloud..."
          echo "Action: $ACTION"
          
          # Get workspace ID (reuse if available)
          if [ -z "$WORKSPACE_ID" ]; then
            echo "ðŸ“‹ Getting workspace information..."
            WORKSPACE_ID=$(curl -s \
              -H "Authorization: Bearer $TF_API_TOKEN" \
              -H "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/organizations/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE" \
              | jq -r '.data.id')
            
            if [ "$WORKSPACE_ID" == "null" ] || [ -z "$WORKSPACE_ID" ]; then
              echo "âŒ Failed to get workspace ID"
              exit 1
            fi
            echo "âœ… Workspace ID: $WORKSPACE_ID"
          fi
          
          # For recreate actions, we need to first destroy then create
          if [ "$ACTION" == "recreate-redis" ] || [ "$ACTION" == "recreate-storage-resources" ]; then
            echo "ðŸ—‘ï¸ Step 1: Destroying Redis cache..."
            
            REDIS_DESTROY_RUN_ID=$(curl -s \
              -X POST \
              -H "Authorization: Bearer $TF_API_TOKEN" \
              -H "Content-Type: application/vnd.api+json" \
              -d "{
                \"data\": {
                  \"type\": \"runs\",
                  \"attributes\": {
                    \"message\": \"Targeted destroy Redis for recreation - triggered by ${{ github.actor }}\",
                    \"is-destroy\": true,
                    \"target-addrs\": [\"azurerm_redis_cache.redis_cache\"]
                  },
                  \"relationships\": {
                    \"workspace\": {
                      \"data\": {
                        \"type\": \"workspaces\",
                        \"id\": \"$WORKSPACE_ID\"
                      }
                    }
                  }
                }
              }" \
              "https://app.terraform.io/api/v2/runs" \
              | jq -r '.data.id')
            
            echo "ðŸ“‹ Redis destroy run: $REDIS_DESTROY_RUN_ID"
            
            # Wait for Redis destroy
            for i in {1..40}; do
              RUN_STATUS=$(curl -s \
                -H "Authorization: Bearer $TF_API_TOKEN" \
                "https://app.terraform.io/api/v2/runs/$REDIS_DESTROY_RUN_ID" \
                | jq -r '.data.attributes.status')
              
              echo "Redis destroy ($i/40): $RUN_STATUS"
              
              if [ "$RUN_STATUS" == "applied" ] || [ "$RUN_STATUS" == "planned_and_finished" ]; then
                echo "âœ… Redis destroyed successfully"
                break
              elif [ "$RUN_STATUS" == "errored" ] || [ "$RUN_STATUS" == "canceled" ]; then
                echo "âŒ Redis destroy failed: $RUN_STATUS"
                exit 1
              fi
              
              sleep 15
            done
          fi
          
          if [ "$ACTION" == "recreate-acr" ] || [ "$ACTION" == "recreate-storage-resources" ]; then
            echo "ðŸ—‘ï¸ Step 2: Destroying Container Registry..."
            
            ACR_DESTROY_RUN_ID=$(curl -s \
              -X POST \
              -H "Authorization: Bearer $TF_API_TOKEN" \
              -H "Content-Type: application/vnd.api+json" \
              -d "{
                \"data\": {
                  \"type\": \"runs\",
                  \"attributes\": {
                    \"message\": \"Targeted destroy ACR for recreation - triggered by ${{ github.actor }}\",
                    \"is-destroy\": true,
                    \"target-addrs\": [\"azurerm_container_registry.acr\"]
                  },
                  \"relationships\": {
                    \"workspace\": {
                      \"data\": {
                        \"type\": \"workspaces\",
                        \"id\": \"$WORKSPACE_ID\"
                      }
                    }
                  }
                }
              }" \
              "https://app.terraform.io/api/v2/runs" \
              | jq -r '.data.id')
            
            echo "ðŸ“‹ ACR destroy run: $ACR_DESTROY_RUN_ID"
            
            # Wait for ACR destroy
            for i in {1..40}; do
              RUN_STATUS=$(curl -s \
                -H "Authorization: Bearer $TF_API_TOKEN" \
                "https://app.terraform.io/api/v2/runs/$ACR_DESTROY_RUN_ID" \
                | jq -r '.data.attributes.status')
              
              echo "ACR destroy ($i/40): $RUN_STATUS"
              
              if [ "$RUN_STATUS" == "applied" ] || [ "$RUN_STATUS" == "planned_and_finished" ]; then
                echo "âœ… ACR destroyed successfully"
                break
              elif [ "$RUN_STATUS" == "errored" ] || [ "$RUN_STATUS" == "canceled" ]; then
                echo "âŒ ACR destroy failed: $RUN_STATUS"
                exit 1
              fi
              
              sleep 15
            done
          fi
          
          # Step 3: Full terraform apply to recreate everything
          echo "ðŸ”„ Step 3: Full Terraform apply to recreate resources..."
          sleep 30  # Wait before recreating
          
          CREATE_RUN_ID=$(curl -s \
            -X POST \
            -H "Authorization: Bearer $TF_API_TOKEN" \
            -H "Content-Type: application/vnd.api+json" \
            -d "{
              \"data\": {
                \"type\": \"runs\",
                \"attributes\": {
                  \"message\": \"Full apply to recreate storage resources - triggered by ${{ github.actor }}\"
                },
                \"relationships\": {
                  \"workspace\": {
                    \"data\": {
                      \"type\": \"workspaces\",
                      \"id\": \"$WORKSPACE_ID\"
                    }
                  }
                }
              }
            }" \
            "https://app.terraform.io/api/v2/runs" \
            | jq -r '.data.id')
          
          echo "âœ… Full apply run created: $CREATE_RUN_ID"
          echo "ðŸ”— Monitor: https://app.terraform.io/app/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE/runs/$CREATE_RUN_ID"
          
          # Wait for recreation to complete
          echo "â³ Waiting for full apply to complete..."
          for i in {1..60}; do
            RUN_STATUS=$(curl -s \
              -H "Authorization: Bearer $TF_API_TOKEN" \
              "https://app.terraform.io/api/v2/runs/$CREATE_RUN_ID" \
              | jq -r '.data.attributes.status')
            
            echo "Apply status ($i/60): $RUN_STATUS"
            
            if [ "$RUN_STATUS" == "applied" ] || [ "$RUN_STATUS" == "planned_and_finished" ]; then
              echo "âœ… Full apply completed successfully"
              break
            elif [ "$RUN_STATUS" == "planned" ]; then
              echo "âš ï¸  Full apply plan ready - manual approval may be required"
              break
            elif [ "$RUN_STATUS" == "errored" ] || [ "$RUN_STATUS" == "canceled" ]; then
              echo "âŒ Full apply failed: $RUN_STATUS"
              exit 1
            fi
            
            sleep 15
          done
          
          echo ""
          echo "ðŸ”„ Recreation Summary:"
          case "$ACTION" in
            "recreate-redis")
              echo "  â€¢ Redis cache: âœ… Recreated with fresh instance"
              echo "  â€¢ Cache data: âš ï¸  Empty (as expected)"
              echo "  â€¢ Key Vault secrets: âœ… Automatically updated"
              ;;
            "recreate-acr")
              echo "  â€¢ Container Registry: âœ… Recreated with fresh instance"
              echo "  â€¢ Container images: âš ï¸  Lost (need rebuild)"
              echo "  â€¢ Key Vault secrets: âœ… Automatically updated"
              ;;
            "recreate-storage-resources")
              echo "  â€¢ Redis cache: âœ… Recreated (empty)"
              echo "  â€¢ Container Registry: âœ… Recreated (no images)"
              echo "  â€¢ All Key Vault secrets: âœ… Automatically updated"
              echo "  â€¢ Dependencies: âœ… Consistent"
              ;;
          esac
          echo ""
          echo "âœ… Storage resources recreation completed successfully!"

      - name:  Terraform Operation Summary
        if: always()
        run: |
          echo "ðŸ“Š Terraform Operation Summary:"
          echo "==============================="
          echo "Action performed: ${{ github.event.inputs.action }}"
          echo "Workspace: $TF_WORKSPACE"
          echo "Organization: $TF_CLOUD_ORGANIZATION"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u)"
          echo ""
          echo "ðŸ”— View workspace: https://app.terraform.io/app/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE"

  # Job 3: Cost Estimation and Summary
  cost-summary:
    runs-on: ubuntu-latest
    needs: [manage-azure-resources, manage-storage-terraform]
    if: always()
    steps:
      - name: ðŸ’° Cost Impact Summary
        run: |
          echo "ðŸ’° Cost Impact Summary"
          echo "====================="
          
          ACTION="${{ github.event.inputs.action }}"
          
          case "$ACTION" in
            "stop-all")
              echo "ðŸ›‘ Resources Stopped:"
              echo "  â€¢ PostgreSQL Flexible Server: ~$20-50/month savings"
              echo "  â€¢ Container App: ~$10-30/month savings" 
              echo "  â€¢ Total estimated savings: ~$30-80/month"
              echo ""
              echo "ðŸ’¡ Benefits:"
              echo "  â€¢ Immediate cost reduction"
              echo "  â€¢ Resources can be restarted quickly"
              echo "  â€¢ Data is preserved"
              ;;
            "start-all")
              echo "ðŸš€ Resources Started:"
              echo "  â€¢ PostgreSQL Flexible Server: ~$20-50/month cost resumed"
              echo "  â€¢ Container App: ~$10-30/month cost resumed"
              echo "  â€¢ Total estimated cost resumed: ~$30-80/month"
              echo ""
              echo "âœ… Services:"
              echo "  â€¢ Database ready for connections"
              echo "  â€¢ API ready to handle requests"
              echo "  â€¢ Full application functionality restored"
              ;;
            "stop-database")
              echo "ðŸ›‘ Database Server Stopped:"
              echo "  â€¢ PostgreSQL Flexible Server: ~$20-50/month savings"
              echo "  â€¢ âš ï¸  Application will lose database connectivity"
              ;;
            "start-database")
              echo "ðŸš€ Database Server Started:"
              echo "  â€¢ PostgreSQL Flexible Server: ~$20-50/month cost resumed"
              echo "  â€¢ âœ… Database ready for connections"
              ;;
            "stop-container-app")
              echo "ðŸ›‘ Container App Stopped:"
              echo "  â€¢ Container App: ~$10-30/month savings"
              echo "  â€¢ âš ï¸  API endpoints will be unavailable"
              ;;
            "start-container-app")
              echo "ðŸš€ Container App Started:"
              echo "  â€¢ Container App: ~$10-30/month cost resumed"
              echo "  â€¢ âœ… API ready to handle requests"
              ;;
            "destroy-redis")
              echo "ðŸ—‘ï¸ Redis Cache Destroyed:"
              echo "  â€¢ Redis Standard C1: ~$15-25/month savings"
              echo "  â€¢ âš ï¸  Data permanently lost - ensure backups if needed"
              echo "  â€¢ âš ï¸  Applications will lose cache functionality"
              ;;
            "recreate-redis")
              echo "ðŸ”„ Redis Cache Recreated:"
              echo "  â€¢ Redis Standard C1: ~$15-25/month cost resumed"
              echo "  â€¢ ðŸ—‘ï¸ Previous data lost - cache will be empty"
              echo "  â€¢ âœ… Fresh cache instance available"
              ;;
            "destroy-acr")
              echo "ðŸ—‘ï¸ Container Registry Destroyed:"
              echo "  â€¢ ACR Basic/Standard: ~$5-50/month savings"
              echo "  â€¢ âš ï¸  All container images permanently lost"
              echo "  â€¢ âš ï¸  Applications will need image rebuilds"
              ;;
            "recreate-acr")
              echo "ðŸ”„ Container Registry Recreated:"
              echo "  â€¢ ACR Basic/Standard: ~$5-50/month cost resumed"
              echo "  â€¢ ðŸ—‘ï¸ All images lost - need rebuild and push"
              echo "  â€¢ âœ… Fresh registry instance available"
              ;;
            "destroy-storage-resources")
              echo "ðŸ—‘ï¸ Storage Resources Destroyed:"
              echo "  â€¢ Redis + ACR: ~$20-75/month savings"
              echo "  â€¢ âš ï¸  All cached data AND images permanently lost"
              echo "  â€¢ âš ï¸  Applications need cache + image rebuilds"
              ;;
            "recreate-storage-resources")
              echo "ðŸ”„ Storage Resources Recreated:"
              echo "  â€¢ Redis + ACR: ~$20-75/month cost resumed"
              echo "  â€¢ ðŸ—‘ï¸ All data and images lost"
              echo "  â€¢ âœ… Fresh instances available - rebuild required"
              ;;
            *)
              echo "Individual resource action performed: $ACTION"
              ;;
          esac
          
          echo ""
          echo "ðŸ“Š Resource Management Tips:"
          echo "  â€¢ Use 'stop-all' during non-business hours for maximum savings"
          echo "  â€¢ Database stop/start may take 2-5 minutes"
          echo "  â€¢ Container apps scale instantly"
          echo "  â€¢ Redis recreation takes 10-15 minutes"
          echo "  â€¢ ACR recreation takes 5-10 minutes"
          echo "  â€¢ 'destroy-storage-resources' = biggest cost savings"
          echo "  â€¢ Always confirm destructive actions"
          echo ""
          echo "â° Recommended Cost Optimization Schedule:"
          echo "  â€¢ Daily: stop-all (6 PM) â†’ start-all (8 AM)"
          echo "  â€¢ Weekly: destroy-storage-resources (Friday) â†’ recreate (Monday)"
          echo "  â€¢ Weekend: stop-all completely"
          echo ""
          echo "ðŸ’¡ Cost Optimization Strategies:"
          echo "  â€¢ destroy-storage-resources: ~$20-75/month savings"
          echo "  â€¢ stop-all: ~$30-80/month savings" 
          echo "  â€¢ Combined approach: ~$50-155/month savings"

      - name: ðŸ“§ Action Completion Summary
        run: |
          echo "## ðŸ—ï¸ IaC Management Action Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Action** | \`${{ github.event.inputs.action }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | \`$(date -u)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Confirmation** | \`${{ github.event.inputs.confirm_destructive }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event.inputs.action }}" == *"redis"* ]]; then
            echo "### ðŸ”— Terraform Cloud" >> $GITHUB_STEP_SUMMARY
            echo "Monitor progress in your [Terraform Cloud workspace](https://app.terraform.io/app/$TF_CLOUD_ORGANIZATION/workspaces/$TF_WORKSPACE)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          case "${{ github.event.inputs.action }}" in
            "stop-all"|"stop-database"|"stop-container-app")
              echo "- Monitor cost savings in Azure Cost Management" >> $GITHUB_STEP_SUMMARY
              echo "- Use corresponding 'start' action to resume services" >> $GITHUB_STEP_SUMMARY
              ;;
            "start-all"|"start-database"|"start-container-app")
              echo "- Verify application functionality" >> $GITHUB_STEP_SUMMARY
              echo "- Check health endpoints" >> $GITHUB_STEP_SUMMARY
              ;;
            "destroy-redis"|"destroy-acr"|"destroy-storage-resources")
              echo "- Verify applications handle missing resources gracefully" >> $GITHUB_STEP_SUMMARY
              echo "- Monitor application performance without these resources" >> $GITHUB_STEP_SUMMARY
              echo "- Consider using 'recreate' actions to restore functionality" >> $GITHUB_STEP_SUMMARY
              ;;
            "recreate-redis"|"recreate-acr"|"recreate-storage-resources")
              echo "- Update application connection strings if needed" >> $GITHUB_STEP_SUMMARY
              if [[ "${{ github.event.inputs.action }}" == *"redis"* ]]; then
                echo "- Warm up Redis cache with frequently accessed data" >> $GITHUB_STEP_SUMMARY
              fi
              if [[ "${{ github.event.inputs.action }}" == *"acr"* ]]; then
                echo "- Rebuild and push container images to new registry" >> $GITHUB_STEP_SUMMARY
                echo "- Update CI/CD pipeline to push latest images" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
          esac
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **IaC Management operation completed successfully!**" >> $GITHUB_STEP_SUMMARY
